<!DOCTYPE html>
<html lang="en">
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8">
				<title>Resolving a Cloudflare IP address</title>

		<style>
		@import url(https://fonts.googleapis.com/css?family=Rajdhani:300);
		html, body {
		  background-color: #212121;
		      width: 100%;
		  height: 100%;
			margin: 0 auto;
		  font-family: 'Rajdhani', sans-serif;
		  font-size: 16px;
		}
		img {
		    border-radius: 12px;
		    border: 2px solid #212121;
		   display: block;
		    margin-left: auto;
		    margin-right: auto;
		    max-width: 100%;
		    height: auto;
		    }
		    img:hover {
		    -webkit-transform: scaleY(-1);
		    transform: scaleY(-1);
		    }

			.header{
			text-align: center;
			color: #00bebe;
			font-size: 3.5em;
		}
		.blog{
			text-align: center;
			color: #00bebe;
			font-size: 1.5em;
		}
		code{
			text-align: center;
			color:white;
			font-size: 18px;
			white-space: pre-wrap;

		}
		a{
			color:  #6698b4;
		}
		span{
			color:white;
		}
		hr{
			color: #00bebe;
		}
</style>
	</head>
	<body>
	<div class="header">
			<h><u>Resolving a Cloudflare IP Address</u></h>
		</div>

			<div class="blog">
				<br>
				<img src="https://upload.wikimedia.org/wikipedia/en/thumb/a/a2/Cloudflare_logo.svg/1200px-Cloudflare_logo.svg.png" alt="cloudflare" style="width:750px;height:250px";>
<p>Reasons for resolvng the real IP address of a <a href="https://en.wikipedia.org/wiki/Cloudflare" target="_blank">Cloudflare</a> range from hacking to DDoS. If it is possible, there are a few methods that can be used to resolve the IP address. However, good Cloudflare configuration may result in a lack of success.<br> Also,
Keep in mind that a website may use various different IPs and not a single static IP address. To illustrate, example.com may have the IP: 192.168.1.1, whereas, shop.example.com may have the IP: 192.168.1.112.</p>
<p><span style="color:white"><u><b>Pinging subdomains</b></u></span></P>
	<p>This takes advantage of Cloudflare misconfiguration. If the website's domain and subdomains are on one static IP address, it's possible that atleast one may not have been added to the Cloudflare proxy, which if pinged, would result in the protected IP address becoming leaked.<br>Before we come to that stage, we would need to do some reconnaissance and enumerate the website's subdomains.</p>
<p>Let's choose a website from the Internet by complete randomization.</p>
	<p><u><span style="color:white">Terminal:</span></u></p>
	<p>We could just test some common subdomains via a terminal:</p>
	<code>└──╼ $ping donaldjtrump.com
PING donaldjtrump.com (104.16.38.178) 56(84) bytes of data.
64 bytes from 104.16.38.178: icmp_seq=1 ttl=60 time=190 ms
└──╼ $ping cpanel.donaldjtrump.com
ping: cpanel.donaldjtrump.com: Name or service not known
└──╼ $ping admin.donaldjtrump.com
ping: admin.donaldjtrump.com: No address associated with hostname
└──╼ $ping shop.donaldjtrump.com (23.227.38.64) 56(84) bytes of data.
 bytes from 23.227.38.64: icmp_seq=1 ttl=53 time=235 ms

--- shop.donaldjtrump.com ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 235.210/235.210/235.210/0.000 ms
</code>
<p>Ah, just as I was about to suggest skipping this method due to time consumption, we got a result. The initial ping shows the IP 104.16.38.178 which looks like a typical Cloudflare IP. By checking this IP address on <a href="https://shodan,io" target="_blank">shodan.io</a> we get a confirmation that it's a Cloudflare proxy IP.<br>
	Knowing that, we have tried a couple of subdomain pings on this random website and found that  <a href="https://shop.donaldjtrump.com" target="_blank">shop.donaldjtrump.com</a> shows an IP that doesn't belong to Cloudflare.
<br> More reconnaissance would need to be done on this IP to find out it's true nature within the network, and wether or not it's a static address.
All in all, It's much more productive to use tools for this method, such as, <a href="https://github.com/methos2016/recon-ng" target="_blank">Recon-ng</a> and <a href="https://github.com/websploit/websploit">Websploit</a>.
<p><u><span>Recon-ng</span></u></p>
<p>We add the domain, select the modules and run it.</p>
<code>
domain (TEXT): donaldjtrump.com
[recon-ng][trump] > use recon/domains-hosts/brute_hosts
[recon-ng][trump][brute_hosts] > run

-------------------
  DONALDJTRUMP.COM
-------------------
[*] shop.donaldjtrump.com => (A) 23.227.38.64
[*] [host] shop.donaldjtrump.com (23.227.38.64)
[*] sharepoint.donaldjtrump.com => No record found.
[*] talk.donaldjtrump.com => (A) 104.16.35.178
</code>
<p> By looking at the results, we can see that some subdomains contain the Cloudfare proxy, while some do not.</p>
<code>
+-------------------------------------------------------------------------
| rowid |                      host                      |   ip_address  |
+-------------------------------------------------------------------------
| 1     | donaldjtrump.com                               |               |
| 2     | cname.createsend.com                           |               |
| 3     | email.donaldjtrump.com                         |               |
| 4     | email.donaldjtrump.com                         | 103.28.41.12  |
| 5     | email.donaldjtrump.com                         | 103.28.41.11  |
| 6     | secure.donaldjtrump.com                        | 104.16.35.178 |
| 7     | secure.donaldjtrump.com                        | 104.16.36.178 |
| 8     | secure.donaldjtrump.com                        | 104.16.38.178 |
| 9     | secure.donaldjtrump.com                        | 104.16.37.178 |
| 10    | secure.donaldjtrump.com                        | 104.16.34.178 |
| 11    | donald-j-trump-for-president-inc.myshopify.com |               |
| 12    | shop.donaldjtrump.com                          |               |
| 13    | shops.myshopify.com                            |               |
| 14    | shop.donaldjtrump.com                          | 23.227.38.64  |
| 15    | talk.donaldjtrump.com                          | 104.16.36.178 |
| 16    | talk.donaldjtrump.com                          | 104.16.34.178 |
| 17    | talk.donaldjtrump.com                          | 104.16.37.178 |
| 18    | talk.donaldjtrump.com                          | 104.16.35.178 |
| 19    | talk.donaldjtrump.com                          | 104.16.38.178 |
| 20    | www.donaldjtrump.com                           | 104.16.38.178 |
| 21    | www.donaldjtrump.com                           | 104.16.34.178 |
| 22    | www.donaldjtrump.com                           | 104.16.37.178 |
| 23    | www.donaldjtrump.com                           | 104.16.36.178 |
| 24    | www.donaldjtrump.com                           | 104.16.35.178 |
+-------------------------------------------------------------------------
</code>
<p><u><span style="color:white">Websploit</span></u></p>
<code>
	$websploit
wsf > use web/cloudflare_resolver
wsf:CloudFlare Resolver > set TARGET donaldjtrump.com
wsf:CloudFlare Resolver > run

[-------------------------]
[+] Default IP Address : 104.16.34.178
[-------------------------]
[-] mail.donaldjtrump.com : N/A
[-] webmail.donaldjtrump.com : N/A
[+] email.donaldjtrump.com : 103.28.41.12
[-] direct-connect-mail.donaldjtrump.com : N/A
[-] direct.donaldjtrump.com : N/A
[-] direct-connect.donaldjtrump.com : N/A
[-] cpanel.donaldjtrump.com : N/A
[-] ftp.donaldjtrump.com : N/A
</code>
<p>Above, Websploit completed the same process as Recon-ng.</p>
<p><span style="color:white"><u><b>DNS Lookup</b></u></span></P>
	<p> The DNS of a website also holds some useful infomation that may reveal an IP address that isn't Cloudflare.<br>
		There are many tools and websites that will find a DNS, but let's stick to <a href="https://github.com/darkoperator/dnsrecon">dnsrecon</a>
		<p><u><span style="color:white">dnsrecon</span>.</u></p>
		<p>Simply give dnsrecon the target domain:</p>
		<code>
			└──╼ $dnsrecon -d donaldjtrump.com
[*] Performing General Enumeration of Domain: donaldjtrump.com
[-] DNSSEC is not configured for donaldjtrump.com
[*] 	 SOA adel.ns.cloudflare.com 173.245.58.55
[*] 	 NS adel.ns.cloudflare.com 173.245.58.55
[*] 	 Bind Version for 173.245.58.55 20171212
[*] 	 NS brad.ns.cloudflare.com 173.245.59.105
[*] 	 Bind Version for 173.245.59.105 20171212
[*] 	 MX donaldjtrump-com.mail.protection.outlook.com 216.32.181.10
[*] 	 MX donaldjtrump-com.mail.protection.outlook.com 207.46.163.10
[*] 	 A donaldjtrump.com 104.16.34.178
[*] 	 A donaldjtrump.com 104.16.38.178
[*] 	 A donaldjtrump.com 104.16.35.178
[*] 	 A donaldjtrump.com 104.16.37.178
[*] 	 A donaldjtrump.com 104.16.36.178
[*] 	 TXT donaldjtrump.com facebook-domain-verification=inm3t7tu8w4g6t7z1cpvg81ang6tyt
[*] 	 TXT donaldjtrump.com v=spf1 include:spf.protection.outlook.com include:sendgrid.net include:mail.gpeflow.com include:msgfocus.com include:rnc.hosted.strongview.com ~all
[*] 	 TXT donaldjtrump.com google-site-verification=nvk3DvHp6Bufpl29K67QDP7rZLJQ0hks5nlDNd0SJoA
[*] Enumerating SRV Records
[-] No SRV Records Found for donaldjtrump.com
[+] 0 Records Found
		</code>
		<p> There's nothing here that is of much use. The MX record is sometimes useful as it show the email server IP. However, this website is using outlook for it's email, not a private server.
			All other IPs are Cloudfare related.<p>
				<p>By spending time on reconnaissance and mapping the network, the higher the chance there is of uncovering other IP addresses. Recon-ng has other additional useful modules, while <a href="https://www.paterva.com/web7/">Maltego</a> is another good option that had a graphical UI. </p>
				<p><span style="color:white"><u><b>Undelivered Email</b></u></span></p>
				<p>If an email is sent to an address that doesn't exist, the email server may reply with an Undelivered Email reply. The header of the email can then be checked for the IP address of the sender.<br>
				This method can be used to find the sender's IP address of any email that you receive, and vice-vera. This might be a good time to start using <a href="https://tutanota.com/">TutaNota Email</a>, which strips your IP address from the header.</p>
				<p><span style="color:white"><u><b>Image IP grabbers</b></u></span></p>
				<p>This method works well on such websites like forums or any website where you can upload an image.<br>
					It's known that we may come across links where, if we click on them, our IP address might be stored in a database. This method can also done via clickable images.<br>
					In comparison, sending a victim a link gains the same result as sending them an image. Although, they may be persuaded by one or the other, the goal is for the target to click on it.
					Whereas, images can also be used to IP grab a server.<br>
				As a senario, someone may join a forum, go to their profile, upload an avatar that contains an embeded IP grabbing link. The server processes and stores the image, which results in the the server's IP address appears in the attackers database.</p>
				<p><span style="color:white"><u><b>Certificate Transparency</b></u></span></p>
				<p><a href="https://en.wikipedia.org/wiki/Certificate_Transparency">Certificate Transparency </a> shows domains that share the same Cloudflare certificate. This is very useful if the company has different domains under the same certificate. There may be
					various domains that are unrelated to the target, so it'll take some intuition. If our target is <span>example.com</span>, we'll need to check the certificate for domains that are similar, such as, <span>example.xyz</span>.
					At the same time, we should look for domains that are under the same field. <span>If example.com</span> is a tech-support website, <span>fixcomputer.com</span> might be worth looking into. Once those new-found domains have been scouted, we may just come across a static IP address that is shared with our original target.<br>
				recon-ng has a module for doing just this.</p>
				<hr>
			</body>
			</html>
